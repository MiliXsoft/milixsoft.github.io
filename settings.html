<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ustawienia - MiliXsoft</title>
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h2 class="logo">MiliXsoft</h2>
    <button class="nav-item" onclick="window.location.href='dashboard.html'">ğŸ  Strona gÅ‚Ã³wna</button>
    <button class="nav-item" onclick="window.location.href='settings.html'">âš™ï¸ Ustawienia</button>
    <button class="nav-item" id="logoutBtn">ğŸšª Wyloguj</button>
  </aside>

  <main class="content">
      <h1>Ustawienia profilu</h1>
      <form id="settingsForm">
        <label for="nickname">Nick:</label>
        <input type="text" id="nickname" placeholder="Wpisz nowy nick" />

        <label for="avatarInput">Avatar (zdjÄ™cie):</label>
        <input type="file" id="avatarInput" accept="image/*" />

        <button type="submit" class="nav-item" style="margin-top:20px; width:auto;">Zapisz zmiany</button>
      </form>
      <p id="statusMsg" style="margin-top:15px; color:#00bfff;"></p>
    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// ğŸ”¥ WSTAW SWÃ“J CONFIG TUTAJ
const firebaseConfig = {
  apiKey: "AIzaSyAzi6XK8OL8Fr1xLb-pyQw2mMPuI1-g4iM",
  authDomain: "milixsoft-9b81e.firebaseapp.com",
  projectId: "milixsoft-9b81e",
  storageBucket: "milixsoft-9b81e.firebasestorage.app",
  messagingSenderId: "443043131107",
  appId: "1:443043131107:web:1ff1926eff9ada03dedfd6",
  measurementId: "G-F71Z6M69GM"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser;

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";
  currentUser = user;

  const docRef = doc(db, "users", user.uid);
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    document.getElementById("nicknameInput").value = snap.data().nickname || "";
  }
});

// Zapis danych
async function saveData() {
  const nickname = document.getElementById("nicknameInput").value;
  const file = document.getElementById("avatarInput").files[0];

  let avatarURL = null;

  if (file) {
    const storageRef = ref(storage, `avatars/${currentUser.uid}`);
    await uploadBytes(storageRef, file);
    avatarURL = await getDownloadURL(storageRef);
  }

  await setDoc(doc(db, "users", currentUser.uid), {
    nickname: nickname,
    avatar: avatarURL || undefined,
    email: currentUser.email
  }, { merge: true });

  document.getElementById("saveStatus").textContent = "âœ… Zapisano.";
}

document.getElementById("saveBtn").onclick = saveData;

document.getElementById("logoutBtn").onclick = () => {
  signOut(auth).then(() => window.location.href = "index.html");
};
</script>

</body>
</html>
